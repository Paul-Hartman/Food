<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>Food App - Swipe</title>
    <link rel="icon" type="image/svg+xml" href="/static/images/recipe.svg">
    <link rel="stylesheet" href="/static/css/style.css?v=20241218">
</head>
<body style="padding-bottom:0;">
    <div class="header" style="padding:12px 16px;">
        <div style="display:flex;align-items:center;justify-content:space-between;">
            <a href="/discover/{{ meal_type }}" class="back-btn">&larr; Back</a>
            <h1 style="font-size:1rem;" id="deck-title">Loading...</h1>
            <span class="card-badge" id="remaining-count">0</span>
        </div>
    </div>

    <div class="swipe-container" id="swipe-container">
        <div class="swipe-card-stack" id="card-stack">
            <div class="loading">
                <div class="loading-spinner"></div>
                Loading recipes...
            </div>
        </div>
    </div>

    <div class="swipe-empty" id="empty-state" style="display:none;">
        <div class="icon">&#127881;</div>
        <h2>All Done!</h2>
        <p>You've seen all recipes in this deck</p>
        <a href="/discover/{{ meal_type }}" class="btn btn-primary">Choose Another Deck</a>
    </div>

    <div class="swipe-actions" id="swipe-actions">
        <button class="swipe-btn nope" onclick="handleSwipeLeft()" title="Not interested">&#10005;</button>
        <button class="swipe-btn cook" onclick="handleSwipeUp()" title="Cook Tonight">&#9757;</button>
        <button class="swipe-btn yum" onclick="handleSwipeRight()" title="Save for later">&#10084;</button>
    </div>

    <script src="/static/js/tinder-swipe.js"></script>
    <script>
        const mealType = '{{ meal_type }}';
        const deckId = {{ deck_id }};
        let swiper = null;
        let deckData = null;
        let recipes = [];

        async function loadDeck() {
            try {
                const response = await fetch(`/api/decks/${deckId}/recipes`);
                const data = await response.json();

                if (data.error) {
                    throw new Error(data.error);
                }

                deckData = data.deck;
                recipes = data.recipes;

                document.getElementById('deck-title').textContent =
                    `${deckData.icon || ''} ${deckData.name}`;

                if (recipes.length === 0) {
                    showEmptyState();
                    return;
                }

                renderCards();
                initSwiper();
                updateRemainingCount();

            } catch (error) {
                console.error('Failed to load deck:', error);
                document.getElementById('card-stack').innerHTML =
                    '<div class="empty-state"><p>Failed to load recipes</p></div>';
            }
        }

        function renderCards() {
            const stack = document.getElementById('card-stack');
            stack.innerHTML = recipes.map((recipe, index) => `
                <div class="swipe-card ${index === 0 ? 'active' : index === 1 ? 'next-1' : index === 2 ? 'next-2' : 'hidden'}"
                     data-recipe-id="${recipe.id}"
                     data-recipe-name="${escapeHtml(recipe.name)}"
                     data-recipe-image="${recipe.image_url}"
                     data-recipe-category="${recipe.category || ''}"
                     data-recipe-cuisine="${recipe.cuisine || ''}">
                    <div class="swipe-indicator-overlay">
                        <span class="swipe-label nope">NOPE</span>
                        <span class="swipe-label yum">YUM</span>
                        <span class="swipe-label cook">COOK!</span>
                    </div>
                    <div class="swipe-card-image">
                        <img src="${recipe.image_url}" alt="${escapeHtml(recipe.name)}"
                             onerror="this.style.display='none'">
                    </div>
                    <div class="swipe-card-body">
                        <div class="swipe-card-title">${escapeHtml(recipe.name)}</div>
                        <div class="swipe-card-meta">
                            ${recipe.cuisine ? `<span>&#127758; ${recipe.cuisine}</span>` : ''}
                            ${recipe.category ? `<span>&#127860; ${recipe.category}</span>` : ''}
                        </div>
                    </div>
                </div>
            `).join('');
        }

        function initSwiper() {
            const container = document.getElementById('swipe-container');
            swiper = new TinderSwipe(container, {
                threshold: 100,
                onSwipeLeft: handleSwipeLeftData,
                onSwipeRight: handleSwipeRightData,
                onSwipeUp: handleSwipeUpData,
                onDeckEmpty: showEmptyState
            });
        }

        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        function updateRemainingCount() {
            if (swiper) {
                document.getElementById('remaining-count').textContent = swiper.getRemainingCount();
            }
        }

        function showEmptyState() {
            document.getElementById('card-stack').style.display = 'none';
            document.getElementById('swipe-actions').style.display = 'none';
            document.getElementById('empty-state').style.display = 'block';
        }

        // Button handlers
        function handleSwipeLeft() {
            if (swiper) swiper.swipeLeft();
        }

        function handleSwipeRight() {
            if (swiper) swiper.swipeRight();
        }

        function handleSwipeUp() {
            if (swiper) swiper.swipeUp();
        }

        // API call handlers
        async function handleSwipeLeftData(recipeData) {
            updateRemainingCount();
            try {
                await fetch('/api/swipe/left', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(recipeData)
                });
            } catch (error) {
                console.error('Failed to record swipe:', error);
            }
        }

        async function handleSwipeRightData(recipeData) {
            updateRemainingCount();
            try {
                await fetch('/api/swipe/right', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(recipeData)
                });
                showToast('Added to Interested list!', 'success');
            } catch (error) {
                console.error('Failed to record swipe:', error);
            }
        }

        async function handleSwipeUpData(recipeData) {
            updateRemainingCount();
            try {
                await fetch('/api/swipe/up', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        ...recipeData,
                        meal_type: mealType
                    })
                });
                showToast(`Added to ${mealType} deck!`, 'success');
            } catch (error) {
                console.error('Failed to record swipe:', error);
            }
        }

        function showToast(message, type = 'info') {
            const toast = document.createElement('div');
            toast.style.cssText = `
                position: fixed;
                bottom: 100px;
                left: 50%;
                transform: translateX(-50%);
                background: ${type === 'success' ? 'var(--success)' : 'var(--secondary)'};
                color: white;
                padding: 12px 24px;
                border-radius: 24px;
                font-weight: 500;
                z-index: 1000;
                animation: fadeInUp 0.3s ease;
            `;
            toast.textContent = message;
            document.body.appendChild(toast);

            setTimeout(() => {
                toast.style.animation = 'fadeOut 0.3s ease forwards';
                setTimeout(() => toast.remove(), 300);
            }, 2000);
        }

        // Add CSS animations
        const style = document.createElement('style');
        style.textContent = `
            @keyframes fadeInUp {
                from { opacity: 0; transform: translateX(-50%) translateY(20px); }
                to { opacity: 1; transform: translateX(-50%) translateY(0); }
            }
            @keyframes fadeOut {
                to { opacity: 0; }
            }
        `;
        document.head.appendChild(style);

        loadDeck();
    </script>
</body>
</html>
