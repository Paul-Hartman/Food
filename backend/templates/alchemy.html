<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Potion Alchemy - Food App</title>
    <link rel="stylesheet" href="/static/css/style.css">
    <style>
        :root {
            --alchemy-primary: #8b5cf6;
            --alchemy-secondary: #6366f1;
            --alchemy-gold: #f59e0b;
            --alchemy-ember: #ef4444;
            --alchemy-frost: #06b6d4;
            --alchemy-nature: #10b981;
            --cauldron-bg: linear-gradient(180deg, #1e1b4b 0%, #312e81 100%);
        }

        * {
            box-sizing: border-box;
        }

        body {
            background: #f8fafc;
        }

        .alchemy-header {
            background: linear-gradient(135deg, #4c1d95 0%, #7c3aed 50%, #6366f1 100%);
            padding: 16px;
            color: white;
            position: sticky;
            top: 0;
            z-index: 100;
        }

        .header-top {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .header-title {
            font-size: 20px;
            font-weight: 700;
            margin: 0;
        }

        .level-badge {
            display: flex;
            align-items: center;
            gap: 8px;
            background: rgba(0,0,0,0.2);
            padding: 6px 12px;
            border-radius: 20px;
            font-size: 13px;
        }

        .xp-circle {
            width: 24px;
            height: 24px;
            background: linear-gradient(135deg, #f59e0b, #d97706);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 700;
            font-size: 12px;
        }

        /* Main Layout - Side by Side */
        .alchemy-layout {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 16px;
            padding: 16px;
            max-width: 1400px;
            margin: 0 auto;
            min-height: calc(100vh - 140px);
        }

        @media (max-width: 900px) {
            .alchemy-layout {
                grid-template-columns: 1fr;
            }
        }

        /* Left Panel - Ingredients */
        .ingredients-panel {
            background: white;
            border-radius: 16px;
            padding: 16px;
            display: flex;
            flex-direction: column;
            max-height: calc(100vh - 180px);
            overflow: hidden;
        }

        .panel-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 12px;
        }

        .panel-title {
            font-size: 16px;
            font-weight: 700;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .search-box {
            width: 100%;
            padding: 10px 14px;
            border: 1px solid #e2e8f0;
            border-radius: 10px;
            font-size: 14px;
            margin-bottom: 12px;
        }

        .search-box:focus {
            outline: none;
            border-color: var(--alchemy-primary);
        }

        /* Category Tabs */
        .category-tabs {
            display: flex;
            gap: 6px;
            padding-bottom: 12px;
            overflow-x: auto;
            flex-shrink: 0;
        }

        .category-tabs::-webkit-scrollbar {
            display: none;
        }

        .category-tab {
            padding: 6px 12px;
            border-radius: 16px;
            font-size: 12px;
            font-weight: 500;
            background: #f1f5f9;
            color: #64748b;
            cursor: pointer;
            white-space: nowrap;
            border: none;
            transition: all 0.2s;
        }

        .category-tab.active {
            background: var(--alchemy-primary);
            color: white;
        }

        .category-tab:hover:not(.active) {
            background: #e2e8f0;
        }

        /* Ingredient Cards Grid */
        .ingredients-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(140px, 1fr));
            gap: 10px;
            overflow-y: auto;
            flex: 1;
            padding: 4px;
        }

        .ingredient-card {
            background: #f8fafc;
            border-radius: 12px;
            padding: 12px;
            cursor: grab;
            border: 2px solid transparent;
            transition: all 0.2s;
            user-select: none;
            position: relative;
        }

        .ingredient-card:hover {
            border-color: var(--alchemy-primary);
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(139, 92, 246, 0.2);
        }

        .ingredient-card:active {
            cursor: grabbing;
        }

        .ingredient-card.dragging {
            opacity: 0.5;
            transform: scale(0.95);
        }

        .card-icon {
            font-size: 28px;
            text-align: center;
            margin-bottom: 6px;
        }

        .card-name {
            font-size: 12px;
            font-weight: 600;
            text-align: center;
            line-height: 1.2;
            margin-bottom: 6px;
            display: -webkit-box;
            -webkit-line-clamp: 2;
            -webkit-box-orient: vertical;
            overflow: hidden;
        }

        .card-meta {
            display: flex;
            justify-content: center;
            gap: 4px;
            flex-wrap: wrap;
        }

        .health-badge {
            font-size: 10px;
            font-weight: 700;
            padding: 2px 6px;
            border-radius: 8px;
            color: white;
        }

        .health-badge.excellent { background: #22c55e; }
        .health-badge.good { background: #84cc16; }
        .health-badge.poor { background: #f97316; }
        .health-badge.bad { background: #ef4444; }

        .tcm-badge {
            font-size: 9px;
            padding: 2px 5px;
            border-radius: 6px;
        }

        .tcm-badge.hot { background: #fee2e2; color: #991b1b; }
        .tcm-badge.warm { background: #ffedd5; color: #9a3412; }
        .tcm-badge.neutral { background: #f1f5f9; color: #475569; }
        .tcm-badge.cool { background: #e0f2fe; color: #0369a1; }
        .tcm-badge.cold { background: #dbeafe; color: #1d4ed8; }

        .warning-dot {
            position: absolute;
            top: 8px;
            right: 8px;
            width: 8px;
            height: 8px;
            background: #ef4444;
            border-radius: 50%;
        }

        /* Right Panel - Cauldron & Results */
        .cauldron-panel {
            display: flex;
            flex-direction: column;
            gap: 16px;
            max-height: calc(100vh - 180px);
            overflow-y: auto;
        }

        /* Brewing Method */
        .method-selector {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 8px;
            background: white;
            padding: 12px;
            border-radius: 12px;
        }

        .method-card {
            background: #f8fafc;
            border-radius: 10px;
            padding: 10px;
            text-align: center;
            cursor: pointer;
            border: 2px solid transparent;
            transition: all 0.2s;
        }

        .method-card:hover {
            background: #f1f5f9;
        }

        .method-card.selected {
            border-color: var(--alchemy-primary);
            background: #f5f3ff;
        }

        .method-icon {
            font-size: 24px;
        }

        .method-name {
            font-size: 11px;
            font-weight: 600;
            margin-top: 4px;
        }

        /* Cauldron Drop Zone */
        .cauldron-section {
            background: var(--cauldron-bg);
            border-radius: 16px;
            padding: 16px;
            min-height: 200px;
            position: relative;
        }

        .cauldron-section.drag-over {
            box-shadow: 0 0 0 3px var(--alchemy-gold), 0 0 30px rgba(245, 158, 11, 0.4);
        }

        .cauldron-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 12px;
        }

        .cauldron-title {
            color: white;
            font-size: 14px;
            font-weight: 600;
        }

        .clear-btn {
            background: rgba(255,255,255,0.15);
            border: none;
            color: white;
            padding: 6px 12px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 12px;
        }

        .clear-btn:hover {
            background: rgba(255,255,255,0.25);
        }

        .cauldron-contents {
            min-height: 100px;
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            padding: 16px;
            background: rgba(0,0,0,0.2);
            border-radius: 12px;
            border: 2px dashed rgba(255,255,255,0.2);
        }

        .cauldron-contents.drag-over {
            border-color: var(--alchemy-gold);
            background: rgba(245, 158, 11, 0.1);
        }

        .empty-cauldron {
            width: 100%;
            text-align: center;
            color: rgba(255,255,255,0.5);
            padding: 20px;
            font-size: 14px;
        }

        .ingredient-chip {
            display: flex;
            align-items: center;
            gap: 6px;
            background: rgba(255,255,255,0.15);
            padding: 8px 12px;
            border-radius: 20px;
            color: white;
            font-size: 13px;
        }

        .ingredient-chip .amount {
            background: rgba(255,255,255,0.2);
            padding: 2px 6px;
            border-radius: 8px;
            font-size: 11px;
        }

        .ingredient-chip .remove-btn {
            background: none;
            border: none;
            color: rgba(255,255,255,0.6);
            cursor: pointer;
            padding: 0 0 0 4px;
            font-size: 16px;
        }

        .ingredient-chip .remove-btn:hover {
            color: white;
        }

        /* Results Sections */
        .results-section {
            background: white;
            border-radius: 12px;
            padding: 14px;
        }

        .section-title {
            font-size: 14px;
            font-weight: 700;
            margin-bottom: 10px;
            display: flex;
            align-items: center;
            gap: 6px;
        }

        /* Warnings */
        .warnings-section {
            background: linear-gradient(135deg, #fef2f2, #fee2e2);
            border: 2px solid #fca5a5;
            border-radius: 12px;
            padding: 14px;
        }

        .warning-item {
            background: white;
            border-radius: 8px;
            padding: 10px;
            margin-bottom: 8px;
            border-left: 3px solid #ef4444;
            font-size: 12px;
        }

        .warning-item:last-child {
            margin-bottom: 0;
        }

        .warning-item.caution {
            border-left-color: #f59e0b;
        }

        .warning-ingredient {
            font-weight: 600;
            margin-bottom: 4px;
        }

        .warning-severity {
            font-size: 9px;
            padding: 2px 5px;
            border-radius: 4px;
            margin-left: 6px;
        }

        .warning-severity.avoid { background: #fee2e2; color: #991b1b; }
        .warning-severity.caution { background: #fef3c7; color: #92400e; }

        /* Nutrition Summary */
        .nutrition-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 8px;
        }

        .nutrition-item {
            text-align: center;
            padding: 8px;
            background: #f8fafc;
            border-radius: 8px;
        }

        .nutrition-value {
            font-size: 16px;
            font-weight: 700;
            color: var(--alchemy-primary);
        }

        .nutrition-label {
            font-size: 9px;
            color: #64748b;
            text-transform: uppercase;
        }

        /* TCM Balance */
        .tcm-balance {
            background: linear-gradient(90deg, #3b82f6 0%, #64748b 50%, #ef4444 100%);
            height: 6px;
            border-radius: 3px;
            position: relative;
            margin: 10px 0;
        }

        .tcm-marker {
            position: absolute;
            width: 14px;
            height: 14px;
            background: white;
            border: 2px solid #1e293b;
            border-radius: 50%;
            top: 50%;
            transform: translate(-50%, -50%);
        }

        .tcm-labels {
            display: flex;
            justify-content: space-between;
            font-size: 9px;
            color: #94a3b8;
        }

        /* Effects */
        .effect-row {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 8px 0;
            border-bottom: 1px solid #f1f5f9;
        }

        .effect-row:last-child {
            border-bottom: none;
        }

        .effect-icon {
            width: 32px;
            height: 32px;
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 16px;
        }

        .effect-icon.digestion { background: #dcfce7; }
        .effect-icon.brain { background: #dbeafe; }
        .effect-icon.energy { background: #fef3c7; }
        .effect-icon.immunity { background: #d1fae5; }
        .effect-icon.circulation { background: #fee2e2; }
        .effect-icon.sleep { background: #e0e7ff; }

        .effect-info {
            flex: 1;
        }

        .effect-name {
            font-size: 12px;
            font-weight: 600;
        }

        .effect-bar {
            height: 6px;
            background: #e2e8f0;
            border-radius: 3px;
            overflow: hidden;
            margin-top: 4px;
        }

        .effect-bar-fill {
            height: 100%;
            border-radius: 3px;
        }

        .effect-bar-fill.digestion { background: #22c55e; }
        .effect-bar-fill.brain { background: #3b82f6; }
        .effect-bar-fill.energy { background: #f59e0b; }
        .effect-bar-fill.immunity { background: #10b981; }
        .effect-bar-fill.circulation { background: #ef4444; }
        .effect-bar-fill.sleep { background: #6366f1; }

        .effect-strength {
            font-size: 13px;
            font-weight: 700;
            min-width: 40px;
            text-align: right;
        }

        /* Synergy Alert */
        .synergy-alert {
            background: linear-gradient(135deg, #fef3c7, #fde68a);
            border: 2px solid #f59e0b;
            border-radius: 12px;
            padding: 12px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .synergy-icon {
            font-size: 24px;
        }

        .synergy-info {
            flex: 1;
        }

        .synergy-name {
            font-weight: 700;
            font-size: 13px;
            color: #92400e;
        }

        .synergy-desc {
            font-size: 11px;
            color: #a16207;
        }

        .synergy-multiplier {
            background: #f59e0b;
            color: white;
            padding: 4px 10px;
            border-radius: 8px;
            font-weight: 700;
            font-size: 13px;
        }

        /* Brew Button */
        .brew-btn {
            width: 100%;
            padding: 14px;
            font-size: 16px;
            font-weight: 700;
            background: linear-gradient(135deg, #8b5cf6, #7c3aed);
            color: white;
            border: none;
            border-radius: 12px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }

        .brew-btn:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 4px 16px rgba(139, 92, 246, 0.4);
        }

        .brew-btn:disabled {
            background: #cbd5e1;
            cursor: not-allowed;
        }

        /* Amount Modal */
        .modal-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.5);
            z-index: 1000;
            justify-content: center;
            align-items: center;
        }

        .modal-overlay.active {
            display: flex;
        }

        .amount-modal {
            background: white;
            border-radius: 16px;
            padding: 24px;
            width: 90%;
            max-width: 320px;
            text-align: center;
        }

        .amount-modal h3 {
            margin: 0 0 8px 0;
            font-size: 18px;
        }

        .amount-modal .ingredient-preview {
            font-size: 40px;
            margin: 12px 0;
        }

        .amount-slider {
            width: 100%;
            margin: 16px 0;
        }

        .amount-display {
            font-size: 28px;
            font-weight: 700;
            color: var(--alchemy-primary);
            margin-bottom: 16px;
        }

        .modal-buttons {
            display: flex;
            gap: 10px;
        }

        .modal-btn {
            flex: 1;
            padding: 12px;
            border-radius: 10px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
        }

        .modal-btn.cancel {
            background: #f1f5f9;
            border: none;
            color: #64748b;
        }

        .modal-btn.confirm {
            background: var(--alchemy-primary);
            border: none;
            color: white;
        }

        /* Bottom Navigation */
        .bottom-nav {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background: white;
            display: flex;
            justify-content: space-around;
            padding: 8px 0;
            box-shadow: 0 -2px 10px rgba(0,0,0,0.1);
            z-index: 100;
        }

        .nav-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            text-decoration: none;
            color: #94a3b8;
            font-size: 11px;
            padding: 4px 12px;
        }

        .nav-item.active {
            color: var(--alchemy-primary);
        }

        .nav-item .icon {
            font-size: 22px;
            margin-bottom: 2px;
        }

        /* Toast */
        .toast {
            display: none;
            position: fixed;
            bottom: 80px;
            left: 50%;
            transform: translateX(-50%);
            background: #1e293b;
            color: white;
            padding: 12px 24px;
            border-radius: 12px;
            font-size: 14px;
            z-index: 2000;
        }

        .toast.active {
            display: block;
        }

        .toast.success {
            background: #059669;
        }

        /* Loading */
        .loading-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.7);
            z-index: 2000;
            justify-content: center;
            align-items: center;
            flex-direction: column;
            color: white;
        }

        .loading-overlay.active {
            display: flex;
        }

        .loading-icon {
            font-size: 64px;
            animation: bounce 1s ease-in-out infinite;
        }

        @keyframes bounce {
            0%, 100% { transform: translateY(0); }
            50% { transform: translateY(-10px); }
        }
    </style>
</head>
<body>
    <!-- Header -->
    <div class="alchemy-header">
        <div class="header-top">
            <h1 class="header-title">Potion Alchemy</h1>
            <div class="level-badge">
                <div class="xp-circle" id="levelBadge">1</div>
                <span id="totalXP">0</span> XP
            </div>
        </div>
    </div>

    <!-- Main Layout -->
    <div class="alchemy-layout">
        <!-- Left Panel - Ingredients -->
        <div class="ingredients-panel">
            <div class="panel-header">
                <div class="panel-title">
                    <span>Ingredients</span>
                </div>
            </div>
            <input type="text" class="search-box" id="searchBox" placeholder="Search ingredients..." oninput="filterIngredients()">
            <div class="category-tabs" id="categoryTabs">
                <button class="category-tab active" onclick="filterByCategory('all')">All</button>
            </div>
            <div class="ingredients-grid" id="ingredientsGrid">
                <!-- Cards populated by JS -->
            </div>
        </div>

        <!-- Right Panel - Cauldron & Results -->
        <div class="cauldron-panel">
            <!-- Brewing Method -->
            <div class="method-selector" id="methodSelector">
                <!-- Populated by JS -->
            </div>

            <!-- Cauldron -->
            <div class="cauldron-section" id="cauldronSection">
                <div class="cauldron-header">
                    <span class="cauldron-title">Your Cauldron</span>
                    <button class="clear-btn" onclick="clearCauldron()">Clear</button>
                </div>
                <div class="cauldron-contents" id="cauldronContents"
                     ondragover="handleDragOver(event)"
                     ondrop="handleDrop(event)"
                     ondragleave="handleDragLeave(event)">
                    <div class="empty-cauldron">Drag ingredients here to begin...</div>
                </div>
            </div>

            <!-- Warnings (hidden by default) -->
            <div class="warnings-section" id="warningsSection" style="display: none;">
                <div class="section-title">
                    <span>Safety Warnings</span>
                </div>
                <div id="warningsList"></div>
            </div>

            <!-- Nutrition Summary -->
            <div class="results-section" id="nutritionSection" style="display: none;">
                <div class="section-title">Nutrition Summary</div>
                <div class="nutrition-grid">
                    <div class="nutrition-item">
                        <div class="nutrition-value" id="totalCalories">0</div>
                        <div class="nutrition-label">Calories</div>
                    </div>
                    <div class="nutrition-item">
                        <div class="nutrition-value" id="totalProtein">0g</div>
                        <div class="nutrition-label">Protein</div>
                    </div>
                    <div class="nutrition-item">
                        <div class="nutrition-value" id="totalFiber">0g</div>
                        <div class="nutrition-label">Fiber</div>
                    </div>
                    <div class="nutrition-item">
                        <div class="nutrition-value" id="totalSugar">0g</div>
                        <div class="nutrition-label">Sugar</div>
                    </div>
                    <div class="nutrition-item">
                        <div class="nutrition-value" id="totalCaffeine">0mg</div>
                        <div class="nutrition-label">Caffeine</div>
                    </div>
                    <div class="nutrition-item">
                        <div class="nutrition-value" id="avgHealthScore">--</div>
                        <div class="nutrition-label">Health</div>
                    </div>
                </div>
                <div class="tcm-balance">
                    <div class="tcm-marker" id="tcmMarker" style="left: 50%;"></div>
                </div>
                <div class="tcm-labels">
                    <span>Cold</span>
                    <span>Neutral</span>
                    <span>Hot</span>
                </div>
            </div>

            <!-- Synergy Alert -->
            <div class="synergy-alert" id="synergyAlert" style="display: none;">
                <div class="synergy-icon">&#x2728;</div>
                <div class="synergy-info">
                    <div class="synergy-name" id="synergyName">Synergy Detected!</div>
                    <div class="synergy-desc" id="synergyDesc"></div>
                </div>
                <div class="synergy-multiplier" id="synergyMultiplier">2x</div>
            </div>

            <!-- Effects Preview -->
            <div class="results-section" id="effectsSection">
                <div class="section-title">Predicted Effects</div>
                <div id="effectsList">
                    <div style="text-align: center; color: #94a3b8; padding: 20px; font-size: 13px;">
                        Add ingredients to see effects...
                    </div>
                </div>
            </div>

            <!-- Brew Button -->
            <button class="brew-btn" id="brewBtn" onclick="brewPotion()" disabled>
                Brew Potion
            </button>
        </div>
    </div>

    <!-- Amount Selection Modal -->
    <div class="modal-overlay" id="amountModal">
        <div class="amount-modal">
            <h3 id="amountIngredientName">Ingredient</h3>
            <div class="ingredient-preview" id="amountIngredientIcon"></div>
            <input type="range" class="amount-slider" id="amountSlider" min="1" max="100" value="20" oninput="updateAmountDisplay()">
            <div class="amount-display"><span id="amountValue">20</span>g</div>
            <div class="modal-buttons">
                <button class="modal-btn cancel" onclick="closeAmountModal()">Cancel</button>
                <button class="modal-btn confirm" onclick="confirmAmount()">Add</button>
            </div>
        </div>
    </div>

    <!-- Loading Overlay -->
    <div class="loading-overlay" id="loadingOverlay">
        <div class="loading-icon">&#x1F9EA;</div>
        <div style="margin-top: 16px; font-size: 18px;">Brewing...</div>
    </div>

    <!-- Toast -->
    <div class="toast" id="toast"></div>

    <!-- Bottom Navigation -->
    <nav class="bottom-nav">
        <a href="/" class="nav-item">
            <span class="icon">&#x1F4D6;</span>
            Recipes
        </a>
        <a href="/alchemy" class="nav-item active">
            <span class="icon">&#x1F9EA;</span>
            Alchemy
        </a>
        <a href="/calendar" class="nav-item">
            <span class="icon">&#x1F4C5;</span>
            Calendar
        </a>
        <a href="/shopping" class="nav-item">
            <span class="icon">&#x1F6D2;</span>
            Shopping
        </a>
    </nav>

    <script>
        // State
        let brewingMethods = [];
        let selectedMethod = null;
        let ingredients = [];
        let ingredientCategories = [];
        let selectedCategory = 'all';
        let cauldron = [];
        let currentPreview = null;
        let draggedIngredient = null;

        // Effect config
        const effectConfig = {
            'FORTIFY_DIGESTION': { icon: '&#x1F343;', system: 'digestion' },
            'FORTIFY_MIND': { icon: '&#x1F9E0;', system: 'brain' },
            'RESTORE_ENERGY': { icon: '&#x26A1;', system: 'energy' },
            'FORTIFY_IMMUNITY': { icon: '&#x1F6E1;', system: 'immunity' },
            'WARM_CORE': { icon: '&#x1F525;', system: 'circulation' },
            'CALM_SPIRIT': { icon: '&#x1F319;', system: 'sleep' }
        };

        // Initialize
        document.addEventListener('DOMContentLoaded', async () => {
            await fetch('/api/alchemy/init', { method: 'POST' });
            await loadBrewingMethods();
            await loadIngredients();
            await loadJournal();
        });

        async function loadBrewingMethods() {
            try {
                const response = await fetch('/api/alchemy/methods');
                brewingMethods = await response.json();

                const container = document.getElementById('methodSelector');
                container.innerHTML = brewingMethods.map((method, i) => `
                    <div class="method-card ${i === 0 ? 'selected' : ''}"
                         onclick="selectMethod(${method.id})"
                         data-method-id="${method.id}">
                        <div class="method-icon">${method.icon}</div>
                        <div class="method-name">${method.name}</div>
                    </div>
                `).join('');

                if (brewingMethods.length > 0) {
                    selectedMethod = brewingMethods[0].id;
                }
            } catch (error) {
                console.error('Error loading brewing methods:', error);
            }
        }

        async function loadIngredients() {
            try {
                const response = await fetch('/api/alchemy/ingredients');
                const data = await response.json();
                ingredients = data.ingredients || [];
                ingredientCategories = data.categories || [];
                renderCategoryTabs();
                renderIngredientCards();
            } catch (error) {
                console.error('Error loading ingredients:', error);
            }
        }

        async function loadJournal() {
            try {
                const response = await fetch('/api/alchemy/journal');
                const journal = await response.json();
                document.getElementById('levelBadge').textContent = journal.brewer_level;
                document.getElementById('totalXP').textContent = journal.total_xp;
            } catch (error) {
                console.error('Error loading journal:', error);
            }
        }

        function renderCategoryTabs() {
            const container = document.getElementById('categoryTabs');
            const categoryNames = {
                'herbs': 'Herbs', 'adaptogens': 'Adaptogens', 'fruits': 'Fruits',
                'vegetables': 'Veggies', 'proteins': 'Proteins', 'fiber': 'Fiber',
                'sweeteners': 'Sweet', 'teas': 'Teas', 'dairy': 'Dairy',
                'dairy_alt': 'Dairy Alt', 'fats': 'Fats', 'flavoring': 'Flavor'
            };

            container.innerHTML = `
                <button class="category-tab ${selectedCategory === 'all' ? 'active' : ''}"
                        onclick="filterByCategory('all')">All</button>
            ` + ingredientCategories.map(cat => `
                <button class="category-tab ${selectedCategory === cat ? 'active' : ''}"
                        onclick="filterByCategory('${cat}')">${categoryNames[cat] || cat}</button>
            `).join('');
        }

        function filterByCategory(category) {
            selectedCategory = category;
            renderCategoryTabs();
            renderIngredientCards();
        }

        function filterIngredients() {
            renderIngredientCards();
        }

        function renderIngredientCards() {
            const container = document.getElementById('ingredientsGrid');
            const searchTerm = document.getElementById('searchBox').value.toLowerCase();

            const filtered = ingredients.filter(ing => {
                const matchesSearch = !searchTerm ||
                    ing.display_name.toLowerCase().includes(searchTerm) ||
                    ing.name.toLowerCase().includes(searchTerm);
                const matchesCategory = selectedCategory === 'all' || ing.category === selectedCategory;
                return matchesSearch && matchesCategory;
            });

            container.innerHTML = filtered.map(ing => `
                <div class="ingredient-card"
                     draggable="true"
                     ondragstart="handleDragStart(event, ${ing.id})"
                     ondragend="handleDragEnd(event)"
                     onclick="selectIngredientForAmount(${ing.id})">
                    ${ing.warnings && ing.warnings.length > 0 ? '<div class="warning-dot"></div>' : ''}
                    <div class="card-icon">${ing.icon || '&#x1F33F;'}</div>
                    <div class="card-name">${escapeHtml(ing.display_name || ing.name)}</div>
                    <div class="card-meta">
                        <span class="health-badge ${ing.health_category}">${ing.health_score}</span>
                        ${ing.tcm_temperature ? `<span class="tcm-badge ${ing.tcm_temperature}">${ing.tcm_temperature}</span>` : ''}
                    </div>
                </div>
            `).join('');

            if (filtered.length === 0) {
                container.innerHTML = '<div style="grid-column: 1/-1; text-align: center; color: #94a3b8; padding: 40px;">No ingredients found</div>';
            }
        }

        // Drag and Drop
        function handleDragStart(event, ingredientId) {
            draggedIngredient = ingredients.find(i => i.id === ingredientId);
            event.target.classList.add('dragging');
            event.dataTransfer.effectAllowed = 'copy';
        }

        function handleDragEnd(event) {
            event.target.classList.remove('dragging');
            draggedIngredient = null;
        }

        function handleDragOver(event) {
            event.preventDefault();
            event.dataTransfer.dropEffect = 'copy';
            document.getElementById('cauldronContents').classList.add('drag-over');
            document.getElementById('cauldronSection').classList.add('drag-over');
        }

        function handleDragLeave(event) {
            document.getElementById('cauldronContents').classList.remove('drag-over');
            document.getElementById('cauldronSection').classList.remove('drag-over');
        }

        function handleDrop(event) {
            event.preventDefault();
            handleDragLeave(event);

            if (draggedIngredient) {
                selectIngredientForAmount(draggedIngredient.id);
            }
        }

        // Amount Selection
        function selectIngredientForAmount(ingredientId) {
            const ing = ingredients.find(i => i.id === ingredientId);
            if (!ing) {
                console.error('Ingredient not found:', ingredientId);
                return;
            }

            draggedIngredient = ing;
            document.getElementById('amountIngredientName').textContent = ing.display_name || ing.name;
            document.getElementById('amountIngredientIcon').innerHTML = ing.icon || '&#x1F33F;';

            const defaultAmount = ing.typical_serving_g || ing.default_amount_g || 20;
            const maxAmount = ing.max_daily_g ? Math.min(ing.max_daily_g * 2, 100) : 100;

            document.getElementById('amountSlider').max = maxAmount;
            document.getElementById('amountSlider').value = defaultAmount;
            document.getElementById('amountValue').textContent = defaultAmount;

            document.getElementById('amountModal').classList.add('active');
        }

        function updateAmountDisplay() {
            document.getElementById('amountValue').textContent = document.getElementById('amountSlider').value;
        }

        function closeAmountModal() {
            document.getElementById('amountModal').classList.remove('active');
            draggedIngredient = null;
        }

        function confirmAmount() {
            console.log('confirmAmount called, draggedIngredient:', draggedIngredient);
            if (!draggedIngredient) {
                console.error('No draggedIngredient set');
                return;
            }

            // Save the ingredient before closing the modal (which clears it)
            const ing = draggedIngredient;
            const amount = parseInt(document.getElementById('amountSlider').value);
            console.log('Adding ingredient:', ing.name, 'amount:', amount);

            const existing = cauldron.find(c => c.ingredient_id === ing.id);
            if (existing) {
                existing.amount_g += amount;
                console.log('Updated existing ingredient, new amount:', existing.amount_g);
            } else {
                cauldron.push({
                    ingredient_id: ing.id,
                    name: ing.display_name || ing.name,
                    amount_g: amount,
                    data: ing
                });
                console.log('Added new ingredient to cauldron, total:', cauldron.length);
            }

            // Close modal AFTER saving the ingredient
            document.getElementById('amountModal').classList.remove('active');
            draggedIngredient = null;

            renderCauldron();
            updatePreview();
        }

        function selectMethod(methodId) {
            selectedMethod = methodId;
            document.querySelectorAll('.method-card').forEach(el => {
                el.classList.toggle('selected', parseInt(el.dataset.methodId) === methodId);
            });
            if (cauldron.length > 0) {
                updatePreview();
            }
        }

        function renderCauldron() {
            const container = document.getElementById('cauldronContents');

            if (cauldron.length === 0) {
                container.innerHTML = '<div class="empty-cauldron">Drag ingredients here to begin...</div>';
                document.getElementById('brewBtn').disabled = true;
                return;
            }

            container.innerHTML = cauldron.map((item, i) => `
                <div class="ingredient-chip">
                    <span>${escapeHtml(item.name)}</span>
                    <span class="amount">${item.amount_g}g</span>
                    <button class="remove-btn" onclick="removeFromCauldron(${i})">&times;</button>
                </div>
            `).join('');

            document.getElementById('brewBtn').disabled = false;
        }

        function removeFromCauldron(index) {
            cauldron.splice(index, 1);
            renderCauldron();
            updatePreview();
        }

        function clearCauldron() {
            cauldron = [];
            renderCauldron();
            document.getElementById('effectsList').innerHTML = '<div style="text-align: center; color: #94a3b8; padding: 20px; font-size: 13px;">Add ingredients to see effects...</div>';
            document.getElementById('synergyAlert').style.display = 'none';
            document.getElementById('nutritionSection').style.display = 'none';
            document.getElementById('warningsSection').style.display = 'none';
            currentPreview = null;
        }

        async function updatePreview() {
            if (cauldron.length === 0 || !selectedMethod) return;

            updateNutritionSummary();
            updateWarnings();

            try {
                const response = await fetch('/api/alchemy/preview', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        ingredients: cauldron.map(c => ({ ingredient_id: c.ingredient_id, amount_g: c.amount_g })),
                        brewing_method_id: selectedMethod
                    })
                });

                currentPreview = await response.json();
                renderEffects(currentPreview.effects);
                renderSynergies(currentPreview.synergies);
            } catch (error) {
                console.error('Error getting preview:', error);
            }
        }

        function updateNutritionSummary() {
            if (cauldron.length === 0) {
                document.getElementById('nutritionSection').style.display = 'none';
                return;
            }

            let totals = { calories: 0, protein: 0, fiber: 0, sugar: 0, caffeine: 0, healthScoreSum: 0, healthScoreCount: 0, tcmScore: 0 };
            const tcmValues = { 'cold': -2, 'cool': -1, 'neutral': 0, 'warm': 1, 'hot': 2 };

            cauldron.forEach(item => {
                const data = item.data;
                if (!data) return;
                const scale = item.amount_g / (data.typical_serving_g || 100);

                totals.calories += (data.calories_per_100g || 0) * (item.amount_g / 100);
                totals.protein += (data.protein_g || 0) * scale;
                totals.fiber += (data.fiber_g || 0) * scale;
                totals.sugar += (data.sugar_g || 0) * scale;
                totals.caffeine += (data.caffeine_mg || 0) * scale;

                if (data.health_score) {
                    totals.healthScoreSum += data.health_score;
                    totals.healthScoreCount++;
                }

                if (data.tcm_temperature && tcmValues[data.tcm_temperature] !== undefined) {
                    totals.tcmScore += tcmValues[data.tcm_temperature] * scale;
                }
            });

            document.getElementById('totalCalories').textContent = Math.round(totals.calories);
            document.getElementById('totalProtein').textContent = totals.protein.toFixed(1) + 'g';
            document.getElementById('totalFiber').textContent = totals.fiber.toFixed(1) + 'g';
            document.getElementById('totalSugar').textContent = totals.sugar.toFixed(1) + 'g';
            document.getElementById('totalCaffeine').textContent = Math.round(totals.caffeine) + 'mg';
            document.getElementById('avgHealthScore').textContent = totals.healthScoreCount > 0 ? Math.round(totals.healthScoreSum / totals.healthScoreCount) : '--';

            const tcmPercent = Math.max(0, Math.min(100, ((totals.tcmScore / cauldron.length) + 2) / 4 * 100));
            document.getElementById('tcmMarker').style.left = tcmPercent + '%';

            document.getElementById('nutritionSection').style.display = 'block';
        }

        function updateWarnings() {
            if (cauldron.length === 0) {
                document.getElementById('warningsSection').style.display = 'none';
                return;
            }

            let allWarnings = [];

            cauldron.forEach(item => {
                const data = item.data;
                if (!data || !data.warnings) return;
                data.warnings.forEach(warning => {
                    allWarnings.push({ ingredient: item.name, ...warning });
                });
            });

            if (allWarnings.length === 0) {
                document.getElementById('warningsSection').style.display = 'none';
                return;
            }

            document.getElementById('warningsList').innerHTML = allWarnings.map(warning => {
                const severityClass = warning.severity === 'caution' ? 'caution' : '';
                const warningText = warning.text || warning.warning_text || 'Use with caution';
                return `
                    <div class="warning-item ${severityClass}">
                        <div class="warning-ingredient">
                            ${escapeHtml(warning.ingredient)}
                            <span class="warning-severity ${warning.severity}">${warning.severity.toUpperCase()}</span>
                        </div>
                        <div><strong>${escapeHtml(warning.condition)}:</strong> ${escapeHtml(warningText)}</div>
                    </div>
                `;
            }).join('');

            document.getElementById('warningsSection').style.display = 'block';
        }

        function renderEffects(effects) {
            const container = document.getElementById('effectsList');

            if (!effects || effects.length === 0) {
                container.innerHTML = '<div style="text-align: center; color: #94a3b8; padding: 20px; font-size: 13px;">No significant effects detected...</div>';
                return;
            }

            container.innerHTML = effects.map(effect => {
                const config = effectConfig[effect.effect_code] || { icon: '&#x2728;', system: 'default' };
                const strength = Math.round(effect.strength);
                return `
                    <div class="effect-row">
                        <div class="effect-icon ${config.system}">${config.icon}</div>
                        <div class="effect-info">
                            <div class="effect-name">${effect.effect_name}</div>
                            <div class="effect-bar">
                                <div class="effect-bar-fill ${config.system}" style="width: ${strength}%"></div>
                            </div>
                        </div>
                        <div class="effect-strength">${strength}%</div>
                    </div>
                `;
            }).join('');
        }

        function renderSynergies(synergies) {
            const alert = document.getElementById('synergyAlert');
            if (!synergies || synergies.length === 0) {
                alert.style.display = 'none';
                return;
            }

            const synergy = synergies[0];
            document.getElementById('synergyName').textContent = synergy.name;
            document.getElementById('synergyDesc').textContent = synergy.mechanism || 'Synergy detected!';
            document.getElementById('synergyMultiplier').textContent = `${synergy.multiplier}x`;
            alert.style.display = 'flex';
        }

        async function brewPotion() {
            if (cauldron.length === 0 || !selectedMethod) return;

            document.getElementById('loadingOverlay').classList.add('active');

            try {
                const response = await fetch('/api/alchemy/brew', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        ingredients: cauldron.map(c => ({ ingredient_id: c.ingredient_id, amount_g: c.amount_g })),
                        brewing_method_id: selectedMethod
                    })
                });

                const result = await response.json();
                document.getElementById('loadingOverlay').classList.remove('active');

                if (result.error) {
                    showToast(result.error, false);
                    return;
                }

                let message = `Brewed ${result.auto_name}! +${result.xp_earned} XP`;
                showToast(message, true);
                await loadJournal();
                clearCauldron();

            } catch (error) {
                document.getElementById('loadingOverlay').classList.remove('active');
                showToast('Brewing failed!', false);
            }
        }

        function showToast(message, success = true) {
            const toast = document.getElementById('toast');
            toast.textContent = message;
            toast.className = 'toast active' + (success ? ' success' : '');
            setTimeout(() => toast.classList.remove('active'), 4000);
        }

        function escapeHtml(text) {
            if (!text) return '';
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }
    </script>
</body>
</html>
