<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>Recipe - Food App</title>
    <link rel="icon" type="image/svg+xml" href="/static/images/recipe.svg">
    <link rel="stylesheet" href="/static/css/style.css?v=20241218">
</head>
<body>
    <div id="recipe-content">
        <div class="loading" style="padding: 40px;">
            <div class="loading-spinner"></div>
            Loading recipe...
        </div>
    </div>

    <div class="action-buttons" id="action-buttons" style="display: none;">
        <button class="btn btn-outline" onclick="addToShopping()">
            <img src="/static/images/shopping.svg" alt="Add">
            Add to List
        </button>
        <a href="/cook/{{ recipe_id }}" class="btn btn-primary">
            <img src="/static/images/timer.svg" alt="Cook">
            Start Cooking
        </a>
    </div>

    <!-- Ingredient Detail Modal -->
    <div class="detail-overlay" id="ingredient-detail" onclick="closeIngredientDetail(event)">
        <div class="detail-modal">
            <div class="detail-modal-handle"></div>
            <div class="detail-modal-header">
                <div class="detail-modal-image" id="ing-detail-image"></div>
                <button class="detail-modal-close" onclick="closeIngredientDetail()">&times;</button>
            </div>
            <div class="detail-modal-body">
                <h2 class="detail-modal-title" id="ing-detail-name">Ingredient</h2>
                <p class="detail-modal-subtitle" id="ing-detail-category">Category</p>
                <div class="detail-section">
                    <h3 class="detail-section-title">Amount Needed</h3>
                    <p id="ing-detail-amount">100g</p>
                </div>
                <div class="detail-section">
                    <h3 class="detail-section-title">Nutrition per 100g</h3>
                    <div class="nutrition-grid" id="ing-detail-nutrition"></div>
                </div>
            </div>
            <div class="detail-modal-actions">
                <button class="btn btn-outline" onclick="closeIngredientDetail()">Close</button>
            </div>
        </div>
    </div>

    <nav class="bottom-nav">
        <a href="/" class="nav-item active">
            <div class="nav-item-icon"><img src="/static/images/recipe.svg" alt="Recipes"></div>
            Recipes
        </a>
        <a href="/shopping" class="nav-item">
            <div class="nav-item-icon"><img src="/static/images/shopping.svg" alt="Shopping"></div>
            Shopping
        </a>
        <a href="/pantry" class="nav-item">
            <div class="nav-item-icon"><img src="/static/images/pantry.svg" alt="Pantry"></div>
            Pantry
        </a>
        <a href="/nutrition" class="nav-item">
            <div class="nav-item-icon"><img src="/static/images/chart.svg" alt="Nutrition"></div>
            Nutrition
        </a>
    </nav>

    <script>
        const recipeId = {{ recipe_id }};
        let recipeData = null;
        let currentServings = null;
        let originalServings = null;

        // Scale quantity based on serving multiplier
        function scaleQuantity(quantity, unit, multiplier) {
            const numQuantity = parseFloat(quantity) || 0;
            const scaled = numQuantity * multiplier;
            const unitLower = (unit || '').toLowerCase().trim();

            // For pinch/dash, show as whole pinches when scaled
            if (unitLower === 'pinch' || unitLower === 'pinches') {
                const pinches = Math.max(1, Math.round(scaled));
                return `${pinches} ${pinches === 1 ? 'pinch' : 'pinches'}`;
            }
            if (unitLower === 'dash' || unitLower === 'dashes') {
                const dashes = Math.max(1, Math.round(scaled));
                return `${dashes} ${dashes === 1 ? 'dash' : 'dashes'}`;
            }

            // Format nicely
            if (scaled < 1 && scaled > 0) {
                if (Math.abs(scaled - 0.25) < 0.01) return `1/4 ${unit}`;
                if (Math.abs(scaled - 0.33) < 0.02) return `1/3 ${unit}`;
                if (Math.abs(scaled - 0.5) < 0.01) return `1/2 ${unit}`;
                if (Math.abs(scaled - 0.66) < 0.02) return `2/3 ${unit}`;
                if (Math.abs(scaled - 0.75) < 0.01) return `3/4 ${unit}`;
                return `${scaled.toFixed(1)} ${unit}`;
            }

            const formatted = scaled % 1 === 0 ? scaled.toString() : scaled.toFixed(1);
            return `${formatted} ${unit}`;
        }

        function changeServings(delta) {
            currentServings = Math.max(1, currentServings + delta);
            renderRecipe();
        }

        async function loadRecipe() {
            try {
                const response = await fetch(`/api/recipes/${recipeId}`);
                recipeData = await response.json();
                originalServings = recipeData.recipe.servings;
                currentServings = originalServings;
                renderRecipe();
                document.getElementById('action-buttons').style.display = 'flex';
            } catch (error) {
                document.getElementById('recipe-content').innerHTML =
                    '<div class="empty-state"><p>Failed to load recipe</p></div>';
            }
        }

        function renderRecipe() {
            const { recipe, ingredients, steps, nutrition_per_serving } = recipeData;

            document.getElementById('recipe-content').innerHTML = `
                <div class="recipe-header">
                    ${recipe.image_url
                        ? `<div class="recipe-header-image"><img src="${recipe.image_url}" alt="${recipe.name}"></div>`
                        : ''}
                    <div class="recipe-header-content">
                        <a href="/" class="back-btn" style="color: white;">
                            <img src="/static/images/arrow-left.svg" alt="Back" style="width:16px;filter:brightness(0) invert(1);">
                            Back
                        </a>
                        <h1>${recipe.name}</h1>
                        <p>${recipe.description || ''}</p>
                        <div class="recipe-stats">
                            <div class="stat">
                                <img src="/static/images/clock.svg" alt="Prep" class="stat-icon" style="filter:brightness(0) invert(1);">
                                <div class="stat-value">${recipe.prep_time_min}</div>
                                <div class="stat-label">Prep (min)</div>
                            </div>
                            <div class="stat">
                                <img src="/static/images/timer.svg" alt="Cook" class="stat-icon" style="filter:brightness(0) invert(1);">
                                <div class="stat-value">${recipe.cook_time_min}</div>
                                <div class="stat-label">Cook (min)</div>
                            </div>
                            <div class="stat">
                                <img src="/static/images/serving.svg" alt="Servings" class="stat-icon" style="filter:brightness(0) invert(1);">
                                <div class="stat-value" style="display:flex;align-items:center;gap:8px;">
                                    <button onclick="changeServings(-1)" style="width:28px;height:28px;border-radius:50%;border:none;background:rgba(255,255,255,0.3);color:white;font-size:18px;cursor:pointer;">-</button>
                                    <span>${currentServings}</span>
                                    <button onclick="changeServings(1)" style="width:28px;height:28px;border-radius:50%;border:none;background:rgba(255,255,255,0.3);color:white;font-size:18px;cursor:pointer;">+</button>
                                </div>
                                <div class="stat-label">Servings${currentServings !== originalServings ? ' (scaled)' : ''}</div>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="section">
                    <h2 class="section-title">
                        <img src="/static/images/calories.svg" alt="Nutrition">
                        Nutrition per Serving
                    </h2>
                    <div class="nutrition-grid">
                        <div class="nutrition-item">
                            <img src="/static/images/calories.svg" alt="Calories" class="nutrition-item-icon">
                            <div class="nutrition-value">${Math.round(nutrition_per_serving.calories)}</div>
                            <div class="nutrition-label">Calories</div>
                        </div>
                        <div class="nutrition-item">
                            <img src="/static/images/protein.svg" alt="Protein" class="nutrition-item-icon">
                            <div class="nutrition-value">${nutrition_per_serving.protein}g</div>
                            <div class="nutrition-label">Protein</div>
                        </div>
                        <div class="nutrition-item">
                            <img src="/static/images/carbs.svg" alt="Carbs" class="nutrition-item-icon">
                            <div class="nutrition-value">${nutrition_per_serving.carbs}g</div>
                            <div class="nutrition-label">Carbs</div>
                        </div>
                        <div class="nutrition-item">
                            <img src="/static/images/fat.svg" alt="Fat" class="nutrition-item-icon">
                            <div class="nutrition-value">${nutrition_per_serving.fat}g</div>
                            <div class="nutrition-label">Fat</div>
                        </div>
                    </div>
                </div>

                <div class="section">
                    <h2 class="section-title">
                        <img src="/static/images/ingredient.svg" alt="Ingredients">
                        Ingredients
                    </h2>
                    <div class="ingredient-grid">
                        ${ingredients.map(ing => {
                            const multiplier = currentServings / originalServings;
                            const scaledAmount = scaleQuantity(ing.quantity, ing.unit, multiplier);
                            return `
                            <div class="ingredient-card" onclick="showIngredientDetail(${ing.ingredient_id})">
                                <div class="ingredient-card-image">
                                    <img src="/static/images/ingredient.svg" alt="${ing.name}">
                                </div>
                                <div class="ingredient-card-info">
                                    <div class="ingredient-card-name">${ing.name}</div>
                                    <div class="ingredient-card-meta">${ing.notes || ''}</div>
                                </div>
                                <div class="ingredient-card-amount">${scaledAmount}</div>
                            </div>
                        `}).join('')}
                    </div>
                </div>

                <div class="section" style="margin-bottom: 160px;">
                    <h2 class="section-title">
                        <img src="/static/images/recipe.svg" alt="Steps">
                        Steps Preview
                    </h2>
                    <p style="color: var(--text-light); margin-bottom: 12px;">${steps.length} steps total</p>
                    ${steps.slice(0, 3).map((step, i) => `
                        <div class="card card-mini" style="margin-bottom: 8px;">
                            <div class="card-icon" style="background: var(--primary); display: flex; align-items: center; justify-content: center; color: white; font-weight: 600;">
                                ${i + 1}
                            </div>
                            <div class="card-content">
                                <div class="card-title">${step.title}</div>
                                ${step.duration_min ? `<p style="color: var(--text-light); font-size: 0.8rem;">${step.duration_min} min</p>` : ''}
                            </div>
                        </div>
                    `).join('')}
                    ${steps.length > 3 ? `<p style="color: var(--text-light); margin-top: 8px;">... and ${steps.length - 3} more steps</p>` : ''}
                </div>
            `;
        }

        function showIngredientDetail(id) {
            const ing = recipeData.ingredients.find(i => i.ingredient_id === id);
            if (!ing) return;

            const multiplier = currentServings / originalServings;
            const scaledAmount = scaleQuantity(ing.quantity, ing.unit, multiplier);

            document.getElementById('ing-detail-name').textContent = ing.name;
            document.getElementById('ing-detail-category').textContent = ing.category || 'Ingredient';
            document.getElementById('ing-detail-amount').textContent = scaledAmount;
            document.getElementById('ing-detail-image').innerHTML = `
                <div style="width:100%;height:100%;display:flex;align-items:center;justify-content:center;background:linear-gradient(135deg,var(--secondary),var(--primary))">
                    <img src="/static/images/ingredient.svg" style="width:80px;opacity:0.8">
                </div>`;
            document.getElementById('ing-detail-nutrition').innerHTML = `
                <div class="nutrition-item"><div class="nutrition-value">${ing.calories_per_100g || 0}</div><div class="nutrition-label">Calories</div></div>
                <div class="nutrition-item"><div class="nutrition-value">${ing.protein_per_100g || 0}g</div><div class="nutrition-label">Protein</div></div>
                <div class="nutrition-item"><div class="nutrition-value">${ing.carbs_per_100g || 0}g</div><div class="nutrition-label">Carbs</div></div>
                <div class="nutrition-item"><div class="nutrition-value">${ing.fat_per_100g || 0}g</div><div class="nutrition-label">Fat</div></div>`;
            document.getElementById('ingredient-detail').classList.add('active');
        }

        function closeIngredientDetail(e) {
            if (e && e.target !== e.currentTarget) return;
            document.getElementById('ingredient-detail').classList.remove('active');
        }

        async function addToShopping() {
            try {
                const response = await fetch('/api/shopping/generate', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ recipe_ids: [recipeId], clear_existing: false, subtract_pantry: true })
                });
                const result = await response.json();
                if (result.success) alert(`Added ${result.items_added} items to shopping list!`);
            } catch (error) {
                alert('Failed to add to shopping list');
            }
        }

        document.addEventListener('keydown', e => { if (e.key === 'Escape') closeIngredientDetail(); });
        loadRecipe();
    </script>
</body>
</html>
