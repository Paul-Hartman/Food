<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>Food App - Recipes</title>
    <link rel="icon" type="image/svg+xml" href="/static/images/recipe.svg">
    <link rel="stylesheet" href="/static/css/style.css">
</head>
<body>
    <div class="header">
        <h1>Discover Recipes</h1>
        <p class="header-subtitle">Real recipes from around the world</p>
    </div>

    <div class="container">
        <div class="search-bar">
            <img src="/static/images/search.svg" alt="Search">
            <input type="text" id="search-input" placeholder="Search recipes..." oninput="debounceSearch()">
            <a href="/scanner" class="btn btn-sm btn-primary" style="margin-left:8px;padding:8px 12px;">
                <img src="/static/images/pantry.svg" alt="Scan" style="width:18px;filter:brightness(0) invert(1);">
            </a>
        </div>

        <div class="filters" id="category-filters">
            <button class="filter-btn active" data-category="all" onclick="filterByCategory('all')">All</button>
        </div>

        <div class="recipe-grid" id="recipe-grid">
            <div class="loading">
                <div class="loading-spinner"></div>
                Loading recipes...
            </div>
        </div>
    </div>

    <nav class="bottom-nav">
        <a href="/" class="nav-item active">
            <div class="nav-item-icon"><img src="/static/images/recipe.svg" alt="Recipes"></div>
            Recipes
        </a>
        <a href="/discover" class="nav-item">
            <span class="icon">&#128293;</span>
            Discover
        </a>
        <a href="/shopping" class="nav-item">
            <div class="nav-item-icon"><img src="/static/images/shopping.svg" alt="Shopping"></div>
            Shopping
        </a>
        <a href="/nutrition" class="nav-item">
            <div class="nav-item-icon"><img src="/static/images/chart.svg" alt="Nutrition"></div>
            Nutrition
        </a>
    </nav>

    <script>
        let allRecipes = [];
        let categories = [];
        let searchTimeout;

        async function loadCategories() {
            try {
                const response = await fetch('/api/mealdb/categories');
                categories = await response.json();
                renderCategories();
            } catch (error) {
                console.error('Failed to load categories:', error);
            }
        }

        function renderCategories() {
            const container = document.getElementById('category-filters');
            container.innerHTML = '<button class="filter-btn active" data-category="all" onclick="filterByCategory(\'all\')">All</button>';
            categories.slice(0, 8).forEach(cat => {
                const btn = document.createElement('button');
                btn.className = 'filter-btn';
                btn.dataset.category = cat.strCategory;
                btn.textContent = cat.strCategory;
                btn.onclick = () => filterByCategory(cat.strCategory);
                container.appendChild(btn);
            });
        }

        async function loadRecipes() {
            document.getElementById('recipe-grid').innerHTML = '<div class="loading"><div class="loading-spinner"></div>Loading recipes...</div>';
            try {
                // Use batch endpoint for faster loading
                const response = await fetch('/api/mealdb/batch-random?count=8');
                allRecipes = await response.json();
                renderRecipes(allRecipes);
            } catch (error) {
                document.getElementById('recipe-grid').innerHTML = '<div class="empty-state"><p>Failed to load recipes</p></div>';
            }
        }

        async function searchRecipes(query) {
            if (!query) {
                loadRecipes();
                return;
            }
            document.getElementById('recipe-grid').innerHTML = '<div class="loading"><div class="loading-spinner"></div>Searching...</div>';
            try {
                const response = await fetch(`/api/mealdb/search?q=${encodeURIComponent(query)}`);
                const recipes = await response.json();
                renderRecipes(recipes);
            } catch (error) {
                document.getElementById('recipe-grid').innerHTML = '<div class="empty-state"><p>Search failed</p></div>';
            }
        }

        async function filterByCategory(category) {
            document.querySelectorAll('.filter-btn').forEach(b => b.classList.remove('active'));
            event.target.classList.add('active');

            if (category === 'all') {
                loadRecipes();
                return;
            }

            document.getElementById('recipe-grid').innerHTML = '<div class="loading"><div class="loading-spinner"></div>Loading...</div>';
            try {
                const response = await fetch(`/api/mealdb/filter/category/${encodeURIComponent(category)}`);
                const recipes = await response.json();
                renderRecipes(recipes);
            } catch (error) {
                document.getElementById('recipe-grid').innerHTML = '<div class="empty-state"><p>Failed to filter</p></div>';
            }
        }

        function debounceSearch() {
            clearTimeout(searchTimeout);
            searchTimeout = setTimeout(() => {
                searchRecipes(document.getElementById('search-input').value);
            }, 300);
        }

        function renderRecipes(recipes) {
            const grid = document.getElementById('recipe-grid');
            if (!recipes || recipes.length === 0) {
                grid.innerHTML = '<div class="empty-state"><div class="empty-state-icon"><img src="/static/images/recipe.svg" alt="No recipes"></div><p>No recipes found</p></div>';
                return;
            }
            grid.innerHTML = recipes.map((recipe, index) => `
                <a href="/recipe/mealdb/${recipe.id}" class="recipe-card interactive-card bounce-in" style="animation-delay: ${index * 0.05}s"
                   onmousemove="handleTilt3D(event, this)"
                   onmouseleave="resetTilt3D(this)"
                   ontouchstart="handleTouch3D(event, this)"
                   ontouchmove="handleTouchMove3D(event, this)"
                   ontouchend="resetTilt3D(this)">
                    <div class="card-inner">
                        <div class="recipe-card-image">
                            ${recipe.image_url
                                ? `<img src="${recipe.image_url}" alt="${recipe.name}" loading="lazy">`
                                : `<div class="recipe-card-image-placeholder"><img src="/static/images/recipe.svg" alt="Recipe"></div>`}
                        </div>
                        <div class="card-glare"></div>
                        <div class="card-glow"></div>
                        <div class="recipe-card-body">
                            <div class="recipe-card-title">${recipe.name}</div>
                            <div class="card-tags">
                                ${recipe.category ? `<span class="card-tag primary">${recipe.category}</span>` : ''}
                                ${recipe.cuisine ? `<span class="card-tag">${recipe.cuisine}</span>` : ''}
                            </div>
                        </div>
                    </div>
                </a>
            `).join('');
        }

        // Enhanced 3D Tilt effect - corner being moused pushes back
        function handleTilt3D(e, card) {
            const rect = card.getBoundingClientRect();
            const x = e.clientX - rect.left;
            const y = e.clientY - rect.top;
            const centerX = rect.width / 2;
            const centerY = rect.height / 2;

            // Calculate rotation - the side being hovered tilts AWAY (pushes back)
            const rotateX = (centerY - y) / 8;  // Reversed: top goes back when hovered
            const rotateY = (x - centerX) / 8;  // Reversed: right goes back when hovered

            // Calculate depth - corners push back more
            const distFromCenter = Math.sqrt(Math.pow(x - centerX, 2) + Math.pow(y - centerY, 2));
            const maxDist = Math.sqrt(Math.pow(centerX, 2) + Math.pow(centerY, 2));
            const depthFactor = distFromCenter / maxDist;
            const translateZ = -20 * depthFactor; // Push back based on distance from center

            const inner = card.querySelector('.card-inner');
            if (inner) {
                inner.style.transform = `
                    perspective(1000px)
                    rotateX(${rotateX}deg)
                    rotateY(${rotateY}deg)
                    translateZ(${translateZ}px)
                    scale3d(1.02, 1.02, 1.02)
                `;
                inner.style.transition = 'transform 0.1s ease-out';
            }

            // Glare follows cursor
            const glare = card.querySelector('.card-glare');
            if (glare) {
                const glareX = (x / rect.width) * 100;
                const glareY = (y / rect.height) * 100;
                glare.style.background = `radial-gradient(circle at ${glareX}% ${glareY}%, rgba(255,255,255,0.5) 0%, transparent 50%)`;
                glare.style.opacity = '1';
            }

            // Glow intensity based on cursor position
            const glow = card.querySelector('.card-glow');
            if (glow) {
                glow.style.opacity = 0.3 + (depthFactor * 0.4);
            }
        }

        function handleTouch3D(e, card) {
            const touch = e.touches[0];
            handleTilt3D({clientX: touch.clientX, clientY: touch.clientY}, card);
        }

        function handleTouchMove3D(e, card) {
            e.preventDefault();
            handleTouch3D(e, card);
        }

        function resetTilt3D(card) {
            const inner = card.querySelector('.card-inner');
            if (inner) {
                inner.style.transform = 'perspective(1000px) rotateX(0) rotateY(0) translateZ(0) scale3d(1, 1, 1)';
                inner.style.transition = 'transform 0.4s cubic-bezier(0.34, 1.56, 0.64, 1)';
            }
            const glare = card.querySelector('.card-glare');
            if (glare) glare.style.opacity = '0';
            const glow = card.querySelector('.card-glow');
            if (glow) glow.style.opacity = '0';
        }

        loadCategories();
        loadRecipes();
    </script>
</body>
</html>